#!/usr/bin/env bash
# Configure a server with a custom header 'X-Served-By' where the
# value is equal to the hostname of the server processing the request.

# Update package list
apt-get update

# Install Nginx
apt-get -y install nginx

# Set permissions for the web directory
chmod o+w /var/www/html/

# Create a simple 'Hello World!' page
echo "Hello World!" > /var/www/html/index.html

# Configure a custom 404 page
echo "Ceci n'est pas une page" > /var/www/html/404.html

# Backup the default Nginx configuration
cp /etc/nginx/sites-enabled/default ~/defaultBackup

# Configure a redirect line
redirectLine="server_name _;\n\n\tlocation /redirect_me {\n\t\treturn 301 https://github.com;\n\t}"

# Configure an error page
errorPage="server_name _;\n\n\terror_page 404 /404.html;\n"

# Apply configurations to the default Nginx site
sed -i "s|server_name _;|${redirectLine}|" /etc/nginx/sites-enabled/default
sed -i "s|server_name _;|${errorPage}|" /etc/nginx/sites-enabled/default

# Insert the custom header
sed -i "/location \/ {/ a\\\t\tadd_header X-Served-By \$hostname;" /etc/nginx/sites-enabled/default

# Test Nginx for errors
nginx -t

# Restart Nginx
service nginx restart
